<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        /* 必备样式 */
        #scrollWrapper {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .pageWrapper {
            width: 100%;
            height: 100%;
        }

        #bgWrapper {
            width: 100%;
            height: 100%;
            position: absolute;
        }

        .bg {
            position: relative;
            width: 100%;
            height: 100%;
            /* 背景index低 */
            z-index: -1;
        }

        .subBg {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            /* 同为背景index低 */
            z-index: -1 !important;
        }

        *[layout-container] {
            position: relative;
            /* 同为背景index低,subBg index层级 */
            z-index: 100;
        }

        *[layout-container]>div {
            display: block !important;
        }

        *[layout-container]>* {
            display: inline-block;
        }

        /* 其他样式 */

        * {
            padding: 0;
            margin: 0;
            border: 0;
        }

        .square {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 50px;
            background: red;
            margin: 8px;
            top: auto;
        }

        .biger {
            width: 116px;
            height: 116px;
            margin: 8px;
            position: absolute;
            margin-top: -58px;
        }

        .b1 {
            background: blueviolet;
        }

        .b2 {
            background: aqua;
        }

        .b3 {
            background: yellowgreen;
        }
    </style>
</head>

<body>

    <article id="scrollWrapper">
        <section id="bgWrapper">
            <div class="bg b1"></div>
            <div class="bg b2"></div>
            <div class="bg b3"></div>
        </section>
        <section class="pageWrapper">
            <h1>Title</h1>
            <div>22222222222222</div>
            <iframe src="/i/eg_landscape.jpg"></iframe>

            <p>一些老的浏览器不支持 iframe。</p>
            <p>如果得不到支持，iframe 是不可见的。</p>
            <div class="square">1</div>
            <div class="square">2</div>
            <div class="square">3</div>
            <div class="square">4</div>
            <div class="square">5</div>
            <div class="square">6</div>
            <div class="square">7</div>
            <button>asdasd</button>
            <br />
            <div style="height: 200px;" layout-container>
                <h1>这是一个布局结构</h1>
                <span>321</span>
                <div style="display: flex; justify-content: center;">
                    <img src='/content/images/2020/05/20190820245237_LATBwy-1.gif' />
                </div>
                <div style="display: flex; justify-content: center;">
                    <iframe
                        src="https://cn.bing.com/search?q=iframe+&qs=n&form=QBRE&sp=-1&pq=iframe+&sc=8-7&sk=&cvid=277774CB8BDA4571A3F30A1839480CDC"></iframe>
                </div>
                <div class="subBg" style="background: mediumaquamarine;width:100%;height:100%;"></div>
            </div>
            <div style="display: flex; justify-content: center;" layout-container>
                <div class="square">1</div>
                <div class="square">2</div>
                <div class="square">3</div>
                <div class="square">4</div>
                <div class="square">5</div>
                <div class="square">6</div>
                <div class="square">7</div>
                <div class="subBg" style="background: cadetblue;width:100%;height:100%;"></div>
                <div style="display: flex; justify-content: center;height: 400px;" layout-container>
                    <h1>这是嵌套了两层的layout-container</h1>
                    <div layout-container>
                        <iframe style="height: 100px;" src="https://cn.bing.com/search?q=splunk&PC=U316&FORM=CHROMN"></iframe>
                    </div>
                    <div class="square" style="position: absolute;bottom: 0;">absolute && bottom=0</div>
                    <div class="subBg" style="background: chartreuse;"></div>
                </div>
            </div>
            <input style="position: absolute;bottom: 0;" />
        </section>
        <section class="pageWrapper">
            <h1>Title</h1>
            <div>22222222222222</div>
            <iframe src="/i/eg_landscape.jpg"></iframe>

            <p>一些老的浏览器不支持 iframe。</p>
            <p>如果得不到支持，iframe 是不可见的。</p>
            <div class="square">1</div>
            <div class="square">2</div>
            <div class="square">3</div>
            <div class="square">4</div>
            <div class="square">5</div>
            <div class="square">6</div>
            <div class="square">7</div>
            <div class="square">8</div>
            <br />
            <div class="square">1</div>
            <div class="square">2</div>
            <div class="square">3</div>
            <div class="square">4</div>
            <div class="square">5</div>
            <div class="square">6</div>
            <div class="square">7</div>
            <div class="square">8</div>
            <div class="square biger">9</div>
            <div layout-container>
                <h1>124</h1>
                <small>321</small>
                <iframe
                    src="https://cn.bing.com/search?q=iframe+&qs=n&form=QBRE&sp=-1&pq=iframe+&sc=8-7&sk=&cvid=277774CB8BDA4571A3F30A1839480CDC"></iframe>
                <div class="subBg" style="background: mediumaquamarine;"></div>
            </div>
        </section>
        <section class="pageWrapper">
            <h1>Title</h1>
            <div>22222222222222</div>
            <iframe src="/i/eg_landscape.jpg"></iframe>

            <p>一些老的浏览器不支持 iframe。</p>
            <p>如果得不到支持，iframe 是不可见的。</p>
            <div class="square">1</div>
            <div class="square">2</div>
            <div class="square">3</div>
            <div class="square">4</div>
            <div class="square">5</div>
            <div class="square">6</div>
            <div class="square">7</div>
        </section>
        <section class="pageWrapper">
            <h1>Title</h1>
            <div>22222222222222</div>
            <iframe src="/i/eg_landscape.jpg"></iframe>

            <p>一些老的浏览器不支持 iframe。</p>
            <p>如果得不到支持，iframe 是不可见的。</p>
            <div class="square">1</div>
            <div class="square">2</div>
            <div class="square">3</div>
            <div class="square">4</div>
            <div class="square">5</div>
            <div class="square">6</div>
            <div class="square">7</div>
        </section>
    </article>
</body>
<script>
    const cg = console.log

    /*  0.made by zhangchuang
        1.可复用函数pageScroll, 来进行特殊的滚动效果,使用方法: pageScroll('up')向上滑动,pageScroll('down')向下面滑动,
        2.要求html包含id="scrollWrapper"的总容器
            2.1.容器中只可以包含两部分子容器:id="bgWrapper"的背景容器和class="pageWrapper"的页面容器(总容器大小，BFC结构，可以像一个页面一样布局)
                2.1.1.背景容器中书写格式 <div class="bg b1"></div>，bg必须有，b1是自定义的背景样式，可以是背景图片之类的
                2.1.2.页面容器里面正常写html元素就好，如需设置背景需要在最后一位html元素加subBg的class样式
        3.要求存在必备样式，#scrollWrapper，.pageWrapper， #bgWrapper，.bg， *[layout-container]，*[layout-container]>*  */
    const pageScroll = (() => {
        let counter = 0
        const [...pageWrapperList] = document.querySelectorAll('.pageWrapper')
        let scrollHeight = document.querySelector('#scrollWrapper').offsetHeight // 每次移动距离都是scrollWrapper的高度
        const bgWrapper = document.querySelector('#bgWrapper')

        // 监听浏览器resize用, 函数防抖
        function debounce(func, wait) {
            let timeout;
            return function () {
                let context = this;
                let args = arguments;

                if (timeout) clearTimeout(timeout);

                timeout = setTimeout(() => {
                    func.apply(context, args)
                }, wait);
            }
        }

        window.onresize = debounce(() => {
            scrollHeight = document.querySelector('#scrollWrapper').offsetHeight
        }, 300)

        // 处理兼容性问题, 为多个浏览器设置相同css属性与相同值
        const setElementStyle = (element, styleKey, styleValue) => {
            // 首字母大写，如transform 变成 Transform
            const upFristStyleKey = `${styleKey.charAt(0).toUpperCase()}${styleKey.substring(1)}`
            const assembleKeys = [
                `webkit${upFristStyleKey}`,
                `Moz${upFristStyleKey}`,
                `ms${upFristStyleKey}`,
                `O${upFristStyleKey}`,
                styleKey]

            assembleKeys.map(key => {
                element.style[key] = styleValue
            })
        }

        // 闭包，公用上面的变量和函数
        return (direction) => {
            if ((pageWrapperList.length === counter && direction === 'up') || (0 === counter && direction === 'down')) return
            // 设置tanslate和tansform进行移动和动画效果
            // 不同的delay造成一个个移动的效果
            const MoveEl = (curNode, delay) => {
                setElementStyle(curNode, 'transition', `all 0.88s ease ${delay}s`)
                // 不设置setTimeout会导致过渡效果消失
                setTimeout(() => {
                    setElementStyle(curNode, 'transform', `translateY(${-counter * scrollHeight}px)`)
                }, 0)
            }
            const curCunter = counter // 记录计算前的counter,也就是即将离开页的下标的counter
            // counter在计算前进行加减，表示counter对应的pageWrapperList[counter]实际上是操作结束的pageWrapper
            if (direction === 'up') {
                counter++
            } else {
                counter--
            }

            pageWrapperList.map((curPageWrapper, wrapperIndex) => {
                let defaultOutNodeList = [...curPageWrapper.children] // 即将离开页所有子元素，不包含子元素中的子元素
                let defaultInNodeList = [...pageWrapperList[counter].children] // 即将进入页所有子元素，不包含子元素中的子元素
                const curNodeNumber = defaultOutNodeList.length // 记录当前也的标签数。用于确定在当前页的curNodeNumber个标签移动后，移动背景
                let handledInNodeList = [] // 即将离开页所有子元素，包含带有layout-container属性的子元素, 可嵌套
                let handledOutNodeList = [] // 即将进入页所有子元素，包含带有layout-container属性的子元素， 可嵌套
                let moveNodeList = [] // 将被移动的所有元素

                // 将defaultXxxNodeList变为handledXxxNodeList
                const assembleMoveList = (node, moveNodeList) => {
                    let res = []
                    if (node.hasAttribute('layout-container')) {
                        [...node.children].map(node => assembleMoveList(node, moveNodeList))
                    } else {
                        res = [node]
                    }

                    if (moveNodeList === 'handledOutNodeList') {
                        handledOutNodeList = [...handledOutNodeList, ...res]
                    } else {
                        handledInNodeList = [...handledInNodeList, ...res]
                    }
                }

                defaultOutNodeList.map(node => assembleMoveList(node, 'handledOutNodeList'))
                defaultInNodeList.map(node => assembleMoveList(node, 'handledInNodeList'))

                //
                if (curCunter === wrapperIndex) {
                    if (direction === 'down') {
                        // 先离开再进入
                        // 从最后一个元素到第一个开始移动
                        moveNodeList = [...handledInNodeList, ...handledOutNodeList].reverse()
                        cg(handledOutNodeList, handledInNodeList)
                        moveNodeList.map((curNode, nodeIndex) => {
                            // 当前页标签移动完，移动背景
                            if (nodeIndex === curNodeNumber - 1) {
                                MoveEl(bgWrapper, 0.06 * curNodeNumber)
                            }
                            MoveEl(curNode, 0.06 * nodeIndex)
                        })
                    } else {
                        // 先离开再进入
                        // 从第一个元素到最后一个开始移动
                        moveNodeList = [...handledOutNodeList, ...handledInNodeList]
                        cg(handledOutNodeList, handledInNodeList)
                        moveNodeList.map((curNode, nodeIndex) => {
                            if (nodeIndex === curNodeNumber - 1) {
                                MoveEl(bgWrapper, 0.06 * curNodeNumber)
                            }
                            MoveEl(curNode, 0.06 * nodeIndex)
                        })
                    }
                    // 移动其他标签
                } else if ((direction === 'down' && curCunter - 1 !== wrapperIndex) || (direction === 'up' && curCunter + 1 !== wrapperIndex)) {
                    handledOutNodeList.map((curNode, nodeIndex) => {
                        MoveEl(curNode, 0)
                    })
                }
            })
        }
    })()
</script>

</html>